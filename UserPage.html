// Save score to history
function saveScoreToHistory(scoreData) {
    let history = JSON.parse(localStorage.getItem('scoreHistory') || '[]');
    
    // Clean up the scanned data by removing unwanted characters
    scoreData = scoreData.replace(/\?/g, '').replace(/^\/+|\/+$/g, '');
    
    // Check if this exact record already exists
    const exists = history.some(item => item.raw === scoreData);
    if (!exists) {
        const parts = scoreData.split('/');
        if (parts.length === 3) {
            // Clean up each part
            const username = parts[0].trim();
            const score = parts[1].trim();
            const date = parts[2].trim();
            
            // Only process if it's for the current user
            if (username === currentUsername) {
                history.unshift({
                    username: username,
                    score: score,
                    date: date,
                    raw: scoreData
                });
                
                // Update current score
                const scoreChange = parseInt(score);
                if (!isNaN(scoreChange)) {
                    currentScore += scoreChange;
                    currentScoreDisplay.textContent = currentScore;
                    localStorage.setItem('score', currentScore.toString());
                }
                
                localStorage.setItem('scoreHistory', JSON.stringify(history));
                return true;
            } else {
                alert(`This QR code is for ${username}, not ${currentUsername}`);
            }
        }
    }
    return false;
}
